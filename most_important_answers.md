# Ответы + решения по проекту (Bybit P2P analytics)

Источник: `brainstorm.md`

## 1) Пользователь и критерий успеха

**Пользователь:** я.

**Цель:** понять, когда выгоднее:
- купить USDT за RUB (я получаю зарплату в рублях),
- продать USDT за VND (я живу во Вьетнаме),
чтобы максимизировать итоговый курс конвертации.

**Ключевая метрика (предлагаю как “North Star”):**
- `effective_vnd_per_rub(amount, constraints, t)` = (лучший “продать USDT → получить VND” курс VND/USDT) / (лучший “купить USDT за RUB” курс RUB/USDT)
- Всегда считать **для конкретной суммы** и **наборов ограничений** (методы оплаты, мерчанты, рейтинг, лимиты).

**Доп. метрики, которые важно оптимизировать вместе с курсом:**
- вероятность “сделка сорвалась” (прокси: низкий рейтинг/не-мерчант, высокая доля отмен у объявления — если есть),
- время исполнения (прокси: скорость исчезновения/обновления лучших офферов),
- “regret” (насколько хуже, чем лучший вариант в тот же день/неделю).

## 2) Сбор данных и легальность

**Подход:** скрейпинг.

**Ограничение:** только общедоступная информация.

**Решения, которые надо зафиксировать (иначе данные будут “не те”):**
- какие направления и фиаты точно нужны в MVP: `RUB/USDT` и `VND/USDT` (оба направления: buy/sell),
- какие фильтры важны “как у пользователя” (методы оплаты, мерчанты, минимальный рейтинг),
- какие поля сохранять в raw-слое (лучше сохранять ответ целиком + timestamp, чтобы потом пересчитать метрики).

**Безопасность данных:**
- не хранить ничего, что можно считать PII (имена, реквизиты и т.п.), если это вдруг появляется в HTML/ответах.

## 3) Определения рынка и метрик (моя рекомендация по умолчанию)

Поскольку это P2P, “order book” = **список объявлений (ads/offers)**.

**Сущности:**
- `Offer`: `ts`, `fiat`, `asset(USDT)`, `side` (buy/sell), `price_fiat_per_usdt`, `available_usdt` (если есть), `min_fiat`, `max_fiat`, `payment_methods[]`, `is_merchant`, `rating`, `advertiser_id` (если есть), + любые “бейджи”.

**Как интерпретировать стороны для твоей задачи:**
- “Купить USDT за RUB” = выбрать **SELL USDT** объявления в `fiat=RUB` с **минимальной** ценой `RUB/USDT`.
- “Продать USDT за VND” = выбрать **BUY USDT** объявления в `fiat=VND` с **максимальной** ценой `VND/USDT`.

**Главная функция “лучший исполнимый курс” (важно):**
- входы: `amount` (в RUB или VND или USDT — нужно выбрать), `constraints` (методы оплаты, merchant-only, min rating), `max_splits` (можно ли делить на несколько сделок),
- выход: `best_price` и список офферов, на которых это достигается.

Рекомендую считать **две версии**:
1) `best_single_offer_price` — только 1 контрагент (реалистично и быстро).
2) `best_k_split_vwap_price(k)` — “как стакан”: добираем объём по офферам по лучшей цене, пока не наберём сумму (если ты готов делать 2–3 сделки).

**Спреды и распределения:**
- `spread_fiat(t)` для каждого фиата: `best_sell_to_user - best_buy_from_user` (и в % к mid).
- `price_percentiles(t)` по отфильтрованным офферам (p10/p50/p90) — это часто полезнее “средней”.
- “near-best liquidity”: объём в пределах X% от лучшей цены (показывает, насколько “тонкий” рынок).

**Поведение рекламодателей (то, что реально помогает в P2P):**
- частота обновления цены,
- стабильность (дисперсия цены),
- “агрессивность” = насколько оффер часто попадает в топ,
- время жизни оффера (постоянно висит или быстро исчезает).

## 4) Семплинг и bias

**Частота:** стартуем с 30 секунд — ок.

**Сколько офферов снимать:** “top N” без фильтра шумный, поэтому лучше правило:
- скачивать несколько страниц, пока не набралось минимум `M` офферов **после фильтрации** (например, `M=30`), но не более `P` страниц (например, `P=5`), чтобы не упереться в лимиты.

**Bias, который надо контролировать в данных:**
- метод оплаты (очень влияет на цену),
- “merchant vs non-merchant”,
- рейтинг и количество сделок (если доступно),
- сумма (min/max сильно искажает “лучшие” цены).

## 5) “Объём” и ликвидность (прокси)

Если нет реальных трейдов, то разумные прокси:
- `depth(amount, t)` = сколько USDT можно купить/продать в рамках ограничений (и по какой VWAP),
- `offer_half_life` = медианное время до исчезновения топ-оффера,
- “устойчивость топа” = как часто меняется лучший оффер.

## 6) Валидация и decision support (план)

**A. Проверки качества данных (автоматически):**
- пропуски/дыры во времени,
- внезапные скачки в числе офферов/полях (детект “сломался скрейпер”),
- дубликаты, не монотонные таймстемпы.

**B. Бэктест “когда лучше”:**
- для каждого дня/недели и фиксированной суммы считать `effective_vnd_per_rub(t)` по сетке времени,
- baseline: “конвертирую в случайное время” или “в одно и то же время каждый день”,
- метрики: среднее улучшение, p50/p90 улучшения, worst-case regret.

**C. Онлайн-проверка (без реальных сделок):**
- “бумажные сигналы”: логировать рекомендацию (лучший час/окно) и потом сравнивать с тем, что реально было в рынке.

**D. Мини-валидация реальными сделками (когда будешь готов):**
- маленькие суммы 1–2 раза/неделю; записывать фактический итоговый курс и сравнивать с прогнозом “best_single_offer_price”.

**Что показывать пользователю в MVP:**
- график/heatmap `effective_vnd_per_rub` по времени суток (в твоём часовом поясе),
- текущая “лучшая цена” + альтернативы (топ-5) с фильтрами,
- индикатор ликвидности (достаточно ли объёма под твою сумму).

## 7) Вопросы к тебе (чтобы зафиксировать MVP)

1) Какая “типичная сумма” конвертации: в RUB и в VND (и минимальная/максимальная)?
- в RUB от 20 тысяч до 100 тысяч рублей. В VND от 5000000. Но я
2) Какие **методы оплаты** ты реально используешь в RUB и в VND (списком)?
В рублях использую банковские переводы по Системы быстрых платежей или перевод на карту. В VND bank transfer на местный вьетнамский банк.
3) Ты готов делать 1 сделку или 2–3 (разбивать сумму на несколько контрагентов)?
Я могу разбить на несколько сумм.
4) Какие ограничения по риску: только мерчанты? минимальный рейтинг/кол-во сделок?
Мне интересно анализировать не только мерчантов но и простых продавцов чтобы искать выгодные курсы
5) Насколько критична скорость (готов ждать лучший курс часы/дни или нужно “сегодня”)?
Готов ждать лучшего курса днями так как я покупаю пару раз в месяц на крупные суммы.